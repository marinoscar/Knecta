// =============================================================================
// Prisma Schema - Enterprise App Foundation
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// User & Identity
// =============================================================================

model User {
  id                      String    @id @default(uuid()) @db.Uuid
  email                   String    @unique
  displayName             String?   @map("display_name")
  providerDisplayName     String?   @map("provider_display_name")
  profileImageUrl         String?   @map("profile_image_url")
  providerProfileImageUrl String?   @map("provider_profile_image_url")
  isActive                Boolean   @default(true) @map("is_active")
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  identities                UserIdentity[]
  userRoles                 UserRole[]
  userSettings              UserSettings?
  auditEvents               AuditEvent[]     @relation("ActorEvents")
  settingsUpdates           SystemSettings[] @relation("SettingsUpdater")
  refreshTokens             RefreshToken[]   @relation("UserRefreshTokens")
  allowlistEntriesAdded     AllowedEmail[]   @relation("AllowlistAddedBy")
  allowlistEntry            AllowedEmail?    @relation("AllowlistClaimedBy")
  deviceCodes               DeviceCode[]     @relation("UserDeviceCodes")
  storageObjects            StorageObject[]  @relation("UserStorageObjects")
  dataConnections           DataConnection[] @relation("UserDataConnections")
  semanticModels            SemanticModel[]  @relation("UserSemanticModels")
  semanticModelRuns         SemanticModelRun[] @relation("UserSemanticModelRuns")
  ontologies                Ontology[]       @relation("UserOntologies")
  dataChats                 DataChat[]       @relation("UserDataChats")
  dataAgentPreferences      DataAgentPreference[] @relation("UserDataAgentPreferences")
  oauthCodes                OAuthAuthorizationCode[] @relation("UserOAuthCodes")
  spreadsheetProjects       SpreadsheetProject[]     @relation("UserSpreadsheetProjects")
  spreadsheetRuns           SpreadsheetRun[]         @relation("UserSpreadsheetRuns")

  @@map("users")
}

model UserIdentity {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  provider        String
  providerSubject String   @map("provider_subject")
  providerEmail   String?  @map("provider_email")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerSubject])
  @@map("user_identities")
}

// =============================================================================
// RBAC - Roles & Permissions
// =============================================================================

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?

  // Relations
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  description String?

  // Relations
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId String @map("user_id") @db.Uuid
  roleId String @map("role_id") @db.Uuid

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

// =============================================================================
// Settings
// =============================================================================

model SystemSettings {
  id              String   @id @default(uuid()) @db.Uuid
  key             String   @unique
  value           Json
  version         Int      @default(1)
  updatedByUserId String?  @map("updated_by_user_id") @db.Uuid
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  updatedByUser User? @relation("SettingsUpdater", fields: [updatedByUserId], references: [id], onDelete: SetNull)

  @@map("system_settings")
}

model UserSettings {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  value     Json
  version   Int      @default(1)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// =============================================================================
// Audit
// =============================================================================

model AuditEvent {
  id          String   @id @default(uuid()) @db.Uuid
  actorUserId String?  @map("actor_user_id") @db.Uuid
  action      String
  targetType  String   @map("target_type")
  targetId    String   @map("target_id")
  meta        Json?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  actorUser User? @relation("ActorEvents", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([actorUserId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("audit_events")
}

// =============================================================================
// Refresh Tokens (for token rotation)
// =============================================================================

model RefreshToken {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  tokenHash String    @unique @map("token_hash")
  expiresAt DateTime  @map("expires_at") @db.Timestamptz
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz

  // Relations
  user User @relation("UserRefreshTokens", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// =============================================================================
// Allowlist (Email Access Control)
// =============================================================================

model AllowedEmail {
  id          String    @id @default(uuid()) @db.Uuid
  email       String    @unique
  addedById   String?   @map("added_by_id") @db.Uuid
  addedAt     DateTime  @default(now()) @map("added_at") @db.Timestamptz
  claimedById String?   @unique @map("claimed_by_id") @db.Uuid
  claimedAt   DateTime? @map("claimed_at") @db.Timestamptz
  notes       String?

  // Relations
  addedBy   User? @relation("AllowlistAddedBy", fields: [addedById], references: [id], onDelete: SetNull)
  claimedBy User? @relation("AllowlistClaimedBy", fields: [claimedById], references: [id], onDelete: SetNull)

  @@map("allowed_emails")
}

// =============================================================================
// Device Authorization Flow (RFC 8628)
// =============================================================================

enum DeviceCodeStatus {
  pending
  approved
  denied
  expired
}

model DeviceCode {
  id         String           @id @default(uuid()) @db.Uuid
  deviceCode String           @unique @map("device_code")
  userCode   String           @unique @map("user_code")
  userId     String?          @map("user_id") @db.Uuid
  status     DeviceCodeStatus @default(pending)
  clientInfo Json?            @map("client_info")
  scopes     String[]
  expiresAt  DateTime         @map("expires_at") @db.Timestamptz
  createdAt  DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User? @relation("UserDeviceCodes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([deviceCode])
  @@index([userCode])
  @@index([status, expiresAt])
  @@index([userId])
  @@map("device_codes")
}

// =============================================================================
// OAuth Authorization Codes (for MCP OAuth 2.1)
// =============================================================================

model OAuthAuthorizationCode {
  id                    String   @id @default(uuid()) @db.Uuid
  code                  String   @unique @db.VarChar(128)
  userId                String   @map("user_id") @db.Uuid
  clientId              String   @map("client_id") @db.VarChar(2048)
  redirectUri           String   @map("redirect_uri") @db.VarChar(2048)
  scope                 String   @db.VarChar(512)
  codeChallenge         String   @map("code_challenge") @db.VarChar(128)
  codeChallengeMethod   String   @map("code_challenge_method") @db.VarChar(10)
  resource              String?  @db.VarChar(2048)
  expiresAt             DateTime @map("expires_at") @db.Timestamptz
  used                  Boolean  @default(false)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation("UserOAuthCodes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([userId])
  @@index([expiresAt])
  @@map("oauth_authorization_codes")
}

// =============================================================================
// Storage Objects
// =============================================================================

enum StorageObjectStatus {
  pending    // Upload initiated, awaiting chunks
  uploading  // Chunks being uploaded
  processing // Post-upload processing in progress
  ready      // Available for use
  failed     // Upload or processing failed
}

enum DatabaseType {
  postgresql
  mysql
  sqlserver
  databricks
  snowflake
  s3
  azure_blob
}

enum SemanticModelStatus {
  draft
  generating
  ready
  failed
}

enum RunStatus {
  pending
  planning
  executing
  completed
  failed
  cancelled
}

enum OntologyStatus {
  creating
  ready
  failed
}

model StorageObject {
  id              String              @id @default(uuid()) @db.Uuid
  name            String              // Original filename
  size            BigInt              // Total size in bytes (BigInt for GB-scale)
  mimeType        String              @map("mime_type")
  storageKey      String              @unique @map("storage_key") // S3 object key
  storageProvider String              @default("s3") @map("storage_provider")
  bucket          String?
  status          StorageObjectStatus @default(pending)
  s3UploadId      String?             @map("s3_upload_id") // S3 multipart upload ID
  metadata        Json?               // JSONB for flexible metadata
  uploadedById    String?             @map("uploaded_by_id") @db.Uuid
  createdAt       DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  uploadedBy User?                @relation("UserStorageObjects", fields: [uploadedById], references: [id], onDelete: SetNull)
  chunks     StorageObjectChunk[]

  @@index([uploadedById])
  @@index([status])
  @@index([createdAt])
  @@map("storage_objects")
}

model StorageObjectChunk {
  id         String   @id @default(uuid()) @db.Uuid
  objectId   String   @map("object_id") @db.Uuid
  partNumber Int      @map("part_number") // S3 part number (1-10000)
  eTag       String   @map("e_tag") // S3 ETag for verification
  size       BigInt   // Chunk size in bytes
  uploadedAt DateTime @default(now()) @map("uploaded_at") @db.Timestamptz

  // Relations
  object StorageObject @relation(fields: [objectId], references: [id], onDelete: Cascade)

  @@unique([objectId, partNumber])
  @@index([objectId])
  @@map("storage_object_chunks")
}

// =============================================================================
// Data Connections
// =============================================================================

model DataConnection {
  id                  String       @id @default(uuid()) @db.Uuid
  name                String
  description         String?
  dbType              DatabaseType @map("db_type")
  host                String
  port                Int
  databaseName        String?      @map("database_name")
  username            String?
  encryptedCredential String?      @map("encrypted_credential")
  useSsl              Boolean      @default(false) @map("use_ssl")
  options             Json?
  createdByUserId     String?      @map("created_by_user_id") @db.Uuid
  lastTestedAt        DateTime?    @map("last_tested_at") @db.Timestamptz
  lastTestResult      Boolean?     @map("last_test_result")
  lastTestMessage     String?      @map("last_test_message")
  createdAt           DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  createdByUser     User?              @relation("UserDataConnections", fields: [createdByUserId], references: [id], onDelete: SetNull)
  semanticModels    SemanticModel[]    @relation("ConnectionSemanticModels")
  semanticModelRuns SemanticModelRun[] @relation("ConnectionSemanticModelRuns")

  @@index([createdByUserId])
  @@index([dbType])
  @@map("data_connections")
}

// =============================================================================
// Semantic Models
// =============================================================================

model SemanticModel {
  id                String              @id @default(uuid()) @db.Uuid
  name              String
  description       String?
  connectionId      String              @map("connection_id") @db.Uuid
  databaseName      String              @map("database_name")
  status            SemanticModelStatus @default(draft)
  model             Json?               // The full OSI semantic model as structured JSON
  modelVersion      Int                 @default(1) @map("model_version")
  tableCount        Int                 @default(0) @map("table_count")
  fieldCount        Int                 @default(0) @map("field_count")
  relationshipCount Int                 @default(0) @map("relationship_count")
  metricCount       Int                 @default(0) @map("metric_count")
  createdByUserId   String?             @map("created_by_user_id") @db.Uuid
  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  createdByUser User?            @relation("UserSemanticModels", fields: [createdByUserId], references: [id], onDelete: SetNull)
  connection    DataConnection   @relation("ConnectionSemanticModels", fields: [connectionId], references: [id], onDelete: Cascade)
  runs          SemanticModelRun[]
  ontologies    Ontology[]       @relation("SemanticModelOntologies")

  @@index([createdByUserId])
  @@index([connectionId])
  @@index([status])
  @@map("semantic_models")
}

model SemanticModelRun {
  id              String     @id @default(uuid()) @db.Uuid
  semanticModelId String?    @map("semantic_model_id") @db.Uuid
  connectionId    String     @map("connection_id") @db.Uuid
  databaseName    String     @map("database_name")
  selectedSchemas String[]   @map("selected_schemas")
  selectedTables  String[]   @map("selected_tables")
  name            String?
  instructions    String?    @db.Text
  status          RunStatus  @default(pending)
  plan            Json?
  progress        Json?
  errorMessage    String?    @map("error_message")
  startedAt       DateTime?  @map("started_at") @db.Timestamptz
  completedAt     DateTime?  @map("completed_at") @db.Timestamptz
  createdByUserId String?    @map("created_by_user_id") @db.Uuid
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  createdByUser User?          @relation("UserSemanticModelRuns", fields: [createdByUserId], references: [id], onDelete: SetNull)
  semanticModel SemanticModel? @relation(fields: [semanticModelId], references: [id], onDelete: SetNull)
  connection    DataConnection @relation("ConnectionSemanticModelRuns", fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([createdByUserId])
  @@index([semanticModelId])
  @@index([connectionId])
  @@index([status])
  @@map("semantic_model_runs")
}

// =============================================================================
// Ontologies
// =============================================================================

model Ontology {
  id                String         @id @default(uuid()) @db.Uuid
  name              String
  description       String?
  semanticModelId   String         @map("semantic_model_id") @db.Uuid
  createdByUserId   String?        @map("created_by_user_id") @db.Uuid
  status            OntologyStatus @default(creating)
  nodeCount         Int            @default(0) @map("node_count")
  relationshipCount Int            @default(0) @map("relationship_count")
  errorMessage      String?        @map("error_message")
  createdAt         DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  createdByUser User?         @relation("UserOntologies", fields: [createdByUserId], references: [id], onDelete: SetNull)
  semanticModel SemanticModel @relation("SemanticModelOntologies", fields: [semanticModelId], references: [id], onDelete: Cascade)
  dataChats            DataChat[]            @relation("OntologyDataChats")
  dataAgentPreferences DataAgentPreference[] @relation("OntologyDataAgentPreferences")

  @@index([createdByUserId])
  @@index([semanticModelId])
  @@index([status])
  @@map("ontologies")
}

// =============================================================================
// Data Chats
// =============================================================================

model DataChat {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(255)
  ontologyId  String   @map("ontology_id") @db.Uuid
  llmProvider String?  @map("llm_provider") @db.VarChar(50)
  ownerId     String   @map("owner_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  ontology Ontology          @relation("OntologyDataChats", fields: [ontologyId], references: [id], onDelete: Cascade)
  owner    User              @relation("UserDataChats", fields: [ownerId], references: [id], onDelete: Cascade)
  messages DataChatMessage[]

  @@index([ownerId])
  @@index([ontologyId])
  @@map("data_chats")
}

model DataChatMessage {
  id        String   @id @default(uuid()) @db.Uuid
  chatId    String   @map("chat_id") @db.Uuid
  role      String   @db.VarChar(20)
  content   String   @db.Text
  metadata  Json?
  status    String   @default("complete") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  chat      DataChat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  llmTraces LlmTrace[]

  @@index([chatId])
  @@map("data_chat_messages")
}

model LlmTrace {
  id               String   @id @default(uuid()) @db.Uuid
  messageId        String   @map("message_id") @db.Uuid
  phase            String   @db.VarChar(30)
  callIndex        Int      @map("call_index")
  stepId           Int?     @map("step_id")
  purpose          String   @db.VarChar(100)
  provider         String   @db.VarChar(30)
  model            String   @db.VarChar(100)
  temperature      Float?
  structuredOutput Boolean  @default(false) @map("structured_output")
  promptMessages   Json     @map("prompt_messages")
  responseContent  String   @map("response_content") @db.Text
  toolCalls        Json?    @map("tool_calls")
  promptTokens     Int      @default(0) @map("prompt_tokens")
  completionTokens Int      @default(0) @map("completion_tokens")
  totalTokens      Int      @default(0) @map("total_tokens")
  startedAt        DateTime @map("started_at") @db.Timestamptz
  completedAt      DateTime @map("completed_at") @db.Timestamptz
  durationMs       Int      @map("duration_ms")
  error            String?  @db.Text
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  message DataChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([messageId, phase])
  @@map("llm_traces")
}

// =============================================================================
// Data Agent Preferences
// =============================================================================

model DataAgentPreference {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  ontologyId String?  @map("ontology_id") @db.Uuid
  key        String   @db.VarChar(255)
  value      String   @db.Text
  source     String   @default("manual") @db.VarChar(20)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user     User      @relation("UserDataAgentPreferences", fields: [userId], references: [id], onDelete: Cascade)
  ontology Ontology? @relation("OntologyDataAgentPreferences", fields: [ontologyId], references: [id], onDelete: Cascade)

  @@unique([userId, ontologyId, key], name: "user_ontology_key_unique")
  @@index([userId])
  @@index([ontologyId])
  @@map("data_agent_preferences")
}

// =============================================================================
// Spreadsheet Agent
// =============================================================================

enum SpreadsheetProjectStatus {
  draft
  processing
  review_pending
  ready
  failed
  partial
}

enum SpreadsheetFileStatus {
  pending
  analyzing
  analyzed
  extracting
  ready
  failed
}

enum SpreadsheetTableStatus {
  pending
  extracting
  ready
  failed
}

enum SpreadsheetRunStatus {
  pending
  ingesting
  analyzing
  designing
  review_pending
  extracting
  validating
  persisting
  completed
  failed
  cancelled
}

model SpreadsheetProject {
  id              String                   @id @default(uuid()) @db.Uuid
  name            String                   @db.VarChar(255)
  description     String?                  @db.Text
  status          SpreadsheetProjectStatus @default(draft)
  storageProvider String                   @map("storage_provider") @db.VarChar(20)
  outputBucket    String                   @map("output_bucket") @db.VarChar(255)
  outputPrefix    String                   @map("output_prefix") @db.VarChar(500)
  reviewMode      String                   @default("review") @map("review_mode") @db.VarChar(20)
  fileCount       Int                      @default(0) @map("file_count")
  tableCount      Int                      @default(0) @map("table_count")
  totalRows       BigInt                   @default(0) @map("total_rows")
  totalSizeBytes  BigInt                   @default(0) @map("total_size_bytes")
  createdByUserId String?                  @map("created_by_user_id") @db.Uuid
  createdAt       DateTime                 @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime                 @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  createdByUser User?              @relation("UserSpreadsheetProjects", fields: [createdByUserId], references: [id], onDelete: SetNull)
  files         SpreadsheetFile[]  @relation("ProjectFiles")
  tables        SpreadsheetTable[] @relation("ProjectTables")
  runs          SpreadsheetRun[]   @relation("ProjectRuns")

  @@index([createdByUserId])
  @@index([status])
  @@map("spreadsheet_projects")
}

model SpreadsheetFile {
  id              String                @id @default(uuid()) @db.Uuid
  projectId       String                @map("project_id") @db.Uuid
  storageObjectId String?               @map("storage_object_id") @db.Uuid
  fileName        String                @map("file_name") @db.VarChar(255)
  fileType        String                @map("file_type") @db.VarChar(20)
  fileSizeBytes   BigInt                @map("file_size_bytes")
  fileHash        String                @map("file_hash") @db.VarChar(64)
  storagePath     String                @map("storage_path") @db.VarChar(1000)
  sheetCount      Int                   @default(0) @map("sheet_count")
  status          SpreadsheetFileStatus @default(pending)
  analysis        Json?
  errorMessage    String?               @map("error_message") @db.Text
  createdAt       DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project SpreadsheetProject @relation("ProjectFiles", fields: [projectId], references: [id], onDelete: Cascade)
  tables  SpreadsheetTable[]  @relation("FileTables")

  @@index([projectId])
  @@index([status])
  @@map("spreadsheet_files")
}

model SpreadsheetTable {
  id              String                 @id @default(uuid()) @db.Uuid
  projectId       String                 @map("project_id") @db.Uuid
  fileId          String                 @map("file_id") @db.Uuid
  sheetName       String                 @map("sheet_name") @db.VarChar(255)
  tableName       String                 @map("table_name") @db.VarChar(255)
  description     String?                @db.Text
  columns         Json
  rowCount        BigInt                 @default(0) @map("row_count")
  outputPath      String?                @map("output_path") @db.VarChar(1000)
  outputSizeBytes BigInt                 @default(0) @map("output_size_bytes")
  status          SpreadsheetTableStatus @default(pending)
  errorMessage    String?                @map("error_message") @db.Text
  extractionNotes String?                @map("extraction_notes") @db.Text
  createdAt       DateTime               @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime               @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project SpreadsheetProject @relation("ProjectTables", fields: [projectId], references: [id], onDelete: Cascade)
  file    SpreadsheetFile    @relation("FileTables", fields: [fileId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([fileId])
  @@index([status])
  @@map("spreadsheet_tables")
}

model SpreadsheetRun {
  id                     String               @id @default(uuid()) @db.Uuid
  projectId              String               @map("project_id") @db.Uuid
  status                 SpreadsheetRunStatus @default(pending)
  currentPhase           String?              @map("current_phase") @db.VarChar(50)
  progress               Json?
  extractionPlan         Json?                @map("extraction_plan")
  extractionPlanModified Json?                @map("extraction_plan_modified")
  config                 Json?
  stats                  Json?
  errorMessage           String?              @map("error_message") @db.Text
  startedAt              DateTime?            @map("started_at") @db.Timestamptz
  completedAt            DateTime?            @map("completed_at") @db.Timestamptz
  createdByUserId        String?              @map("created_by_user_id") @db.Uuid
  createdAt              DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project       SpreadsheetProject @relation("ProjectRuns", fields: [projectId], references: [id], onDelete: Cascade)
  createdByUser User?              @relation("UserSpreadsheetRuns", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([status])
  @@index([createdByUserId])
  @@map("spreadsheet_runs")
}
